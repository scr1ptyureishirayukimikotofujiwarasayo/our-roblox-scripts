-- LocalScript: Fake Time Stop (Client-side illusion)

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

-- ================= GUI =================

local gui = Instance.new("ScreenGui")
gui.Name = "TimeStopGUI"
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling -- Ensures proper layering
gui.Parent = player:WaitForChild("PlayerGui")

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 200, 0, 50)
button.Position = UDim2.new(0.5, -100, 0.5, -25)
button.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
button.BackgroundTransparency = 0.4
button.BorderSizePixel = 0
button.Text = "" -- Intentionally empty; using label instead
button.AutoButtonColor = false
button.Active = true -- Explicitly enable input
button.Parent = gui

local label = Instance.new("TextLabel")
label.Size = UDim2.new(1, 0, 1, 0)
label.BackgroundTransparency = 1
label.Text = "Time Stop: OFF"
label.TextColor3 = Color3.fromRGB(255, 255, 255)
label.TextSize = 18
label.Font = Enum.Font.SourceSansBold
label.Parent = button

-- ================= STATE =================

local timeStopped = false
local frozenData = {}

-- ================= FREEZE LOGIC =================

local function freezeCharacter(plr)
    if plr == player then return end
    if frozenData[plr] then return end
    if not plr.Character then return end

    local humanoid = plr.Character:FindFirstChildOfClass("Humanoid")
    local root = plr.Character:FindFirstChild("HumanoidRootPart")
    if not humanoid or not root then return end

    frozenData[plr] = {
        WalkSpeed = humanoid.WalkSpeed,
        JumpHeight = humanoid.JumpHeight,
        AutoRotate = humanoid.AutoRotate,
        Anchored = root.Anchored,
    }

    humanoid.WalkSpeed = 0
    humanoid.JumpHeight = 0
    humanoid.AutoRotate = false
    root.Anchored = true

    for _, track in ipairs(humanoid:GetPlayingAnimationTracks()) do
        track:Stop(0)
    end
end

local function unfreezeCharacter(plr)
    local data = frozenData[plr]
    if not data or not plr.Character then return end

    local humanoid = plr.Character:FindFirstChildOfClass("Humanoid")
    local root = plr.Character:FindFirstChild("HumanoidRootPart")
    if not humanoid or not root then return end

    humanoid.WalkSpeed = data.WalkSpeed
    humanoid.JumpHeight = data.JumpHeight
    humanoid.AutoRotate = data.AutoRotate
    root.Anchored = data.Anchored

    frozenData[plr] = nil
end

-- ================= TOGGLE =================

local function toggleTimeStop()
    timeStopped = not timeStopped

    if timeStopped then
        label.Text = "Time Stop: ON"
        button.BackgroundColor3 = Color3.fromRGB(140, 0, 0)

        for _, plr in ipairs(Players:GetPlayers()) do
            freezeCharacter(plr)
        end
    else
        label.Text = "Time Stop: OFF"
        button.BackgroundColor3 = Color3.fromRGB(255, 0, 0)

        -- Iterate over a copy since we're modifying the table
        local playersToUnfreeze = {}
        for plr in pairs(frozenData) do
            table.insert(playersToUnfreeze, plr)
        end
        for _, plr in ipairs(playersToUnfreeze) do
            unfreezeCharacter(plr)
        end
    end
end

-- ================= DRAGGING =================

local dragging = false
local dragStart
local startPos
local dragged = false
local DRAG_THRESHOLD = 5 -- Minimum pixels to count as drag

button.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragged = false
        dragStart = UserInputService:GetMouseLocation()
        startPos = button.Position
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
        -- No need for task.delay; just reset immediately after release
        dragged = false
    end
end)

RunService.RenderStepped:Connect(function()
    if dragging then
        local mousePos = UserInputService:GetMouseLocation()
        local delta = mousePos - dragStart
        -- Only mark as dragged if moved beyond threshold
        if math.abs(delta.X) > DRAG_THRESHOLD or math.abs(delta.Y) > DRAG_THRESHOLD then
            dragged = true
        end
        if dragged then
            button.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end
end)

button.MouseButton1Click:Connect(function()
    if not dragged then
        toggleTimeStop()
    end
end)

-- ================= PLAYER HANDLING =================

Players.PlayerAdded:Connect(function(plr)
    if not timeStopped or plr == player then return end

    plr.CharacterAdded:Connect(function(char)
        task.spawn(function()
            task.wait(0.5) -- Wait for character to fully load
            if char == plr.Character then -- Ensure still current
                freezeCharacter(plr)
            end
        end)
    end)
end)

Players.PlayerRemoving:Connect(function(plr)
    frozenData[plr] = nil
end)
