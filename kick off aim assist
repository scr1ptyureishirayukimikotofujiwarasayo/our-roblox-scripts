-- Aim Assist Script (Corrected + Safe)
-- Automatically adjusts kick trajectory to avoid goalies and score goals

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local MasterKey = ReplicatedStorage:WaitForChild("MasterKey")

-- Goal positions
local GOALS = {
    BlueGoal = Vector3.new(205.1635, -127.9701, -391.3223),
    RedGoal  = Vector3.new(-114.4364, -127.5701, -391.3223)
}

-- Safe sign function
local function sign(x)
    if x > 0 then return 1 end
    if x < 0 then return -1 end
    return 0
end

-- Safe goalie lookup
local function getEnemyGoaliePosition()
    if not LocalPlayer.Team then return nil end

    local teamName = LocalPlayer.Team.Name
    local enemyName = (teamName == "USA") and "Brazil Goalie" or "USA Goalie"

    local map = workspace:FindFirstChild("MapHolder")
    if not map then return nil end

    local void = map:FindFirstChild("Void")
    if not void then return nil end

    local goalies = void:FindFirstChild("Goalies")
    if not goalies then return nil end

    local goalie = goalies:FindFirstChild(enemyName)
    if goalie and goalie:FindFirstChild("HumanoidRootPart") then
        return goalie.HumanoidRootPart.Position
    end

    return nil
end

-- Get target goal
local function getTargetGoalPosition()
    if not LocalPlayer.Team then return nil end

    local teamName = LocalPlayer.Team.Name
    if teamName == "USA" then
        return GOALS.BlueGoal
    elseif teamName == "Brazil" then
        return GOALS.RedGoal
    end

    return nil
end

-- Kick direction calculation
local function calculateOptimalKick(ballPosition, targetGoal, goaliePosition)
    if not goaliePosition then
        return (targetGoal - ballPosition).Unit
    end

    local goalWidth = 35.6
    local goalHeight = 13.2

    local goalieToGoal = goaliePosition - targetGoal
    local perpendicular = Vector3.new(1, 0, 0) -- left/right relative to goal

    local goalieSide = sign(goalieToGoal:Dot(perpendicular))
    local targetSide = -goalieSide

    local offset = perpendicular * (goalWidth * 0.3 * targetSide)
    local heightOffset = Vector3.new(0, goalHeight * 0.4, 0)

    local targetPos = targetGoal + offset + heightOffset
    return (targetPos - ballPosition).Unit
end

-- Hook RemoteEvent safely
local originalFireServer
originalFireServer = hookfunction(MasterKey.FireServer, function(self, actionType, ...)
    local args = {...}

    if actionType == "Kick" and #args >= 4 then
        local kickType = args[1]
        local ball = args[2]
        local power = args[3]
        local velocity = args[4]

        if typeof(ball) == "Instance" and ball:IsA("BasePart") then
            local targetGoal = getTargetGoalPosition()
            local goaliePos = getEnemyGoaliePosition()

            if targetGoal then
                local optimalDir = calculateOptimalKick(ball.Position, targetGoal, goaliePos)
                args[4] = optimalDir * velocity.Magnitude

                if kickType == "Trickshot" then
                    if typeof(args[5]) == "Vector3" then
                        args[5] = optimalDir * args[5].Magnitude
                    end
                    if typeof(args[6]) == "Vector3" then
                        args[6] = optimalDir * args[6].Magnitude
                    end
                end
            end
        end
    end

    return originalFireServer(self, actionType, unpack(args))
end)

-- Visual indicator
local indicator = Instance.new("Part")
indicator.Size = Vector3.new(1, 1, 1)
indicator.Anchored = true
indicator.CanCollide = false
indicator.Material = Enum.Material.Neon
indicator.Color = Color3.fromRGB(0, 255, 0)
indicator.Transparency = 0.5
indicator.Parent = workspace

RunService.Heartbeat:Connect(function()
    local ball = workspace:FindFirstChild("SoccerBall")
    if not ball then return end

    local targetGoal = getTargetGoalPosition()
    if not targetGoal then return end

    local goaliePos = getEnemyGoaliePosition()
    local dir = calculateOptimalKick(ball.Position, targetGoal, goaliePos)

    indicator.Position = ball.Position + dir * 10
end)

print("Aim Assist Loaded")
