-- Services
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-- Configuration
local WINDOW_NAME = "shirayukimikoto's mod menu"
local WINDOW_TITLE = "shirayukimikoto's mod menu"
local COLOR_PRIMARY = Color3.fromRGB(0, 85, 170)
local COLOR_BUTTON = Color3.fromRGB(0, 120, 215)
local COLOR_BG_DARK = Color3.fromRGB(30, 30, 60)
local COLOR_TEXT = Color3.new(1, 1, 1)

-- Helper Functions
local function safeParent(gui)
    local ok = pcall(function()
        gui.Parent = CoreGui
    end)
    if not ok or not gui.Parent then
        local pg = LocalPlayer:WaitForChild("PlayerGui")
        gui.Parent = pg
    end
end

local nextOrder = 1
local function assignOrder(obj)
    obj.LayoutOrder = nextOrder
    nextOrder = nextOrder + 1
end

-- Create Main GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = WINDOW_NAME
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
safeParent(screenGui)

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 340, 0, 600)
mainFrame.Position = UDim2.new(0, 20, 0, 100)
mainFrame.BackgroundColor3 = COLOR_PRIMARY
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.ClipsDescendants = true
mainFrame.Parent = screenGui

-- Title Bar
local titleLabel = Instance.new("TextLabel")
titleLabel.Name = "TitleLabel"
titleLabel.Size = UDim2.new(1, -56, 0, 36)
titleLabel.Position = UDim2.new(0, 8, 0, 8)
titleLabel.BackgroundTransparency = 1
titleLabel.TextColor3 = COLOR_TEXT
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 16
titleLabel.Text = WINDOW_TITLE
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
assignOrder(titleLabel)
titleLabel.Parent = mainFrame

-- Minimize Button
local minimizeButton = Instance.new("TextButton")
minimizeButton.Name = "MinimizeButton"
minimizeButton.Size = UDim2.new(0, 40, 0, 28)
minimizeButton.Position = UDim2.new(1, -48, 0, 8)
minimizeButton.BackgroundColor3 = Color3.fromRGB(20, 20, 40)
minimizeButton.BorderSizePixel = 0
minimizeButton.TextColor3 = COLOR_TEXT
minimizeButton.Font = Enum.Font.GothamSemibold
minimizeButton.TextSize = 18
minimizeButton.Text = "‚Äî"
assignOrder(minimizeButton)
minimizeButton.Parent = mainFrame

-- Minimize Functionality
local minimized = false
local savedFrameState = {
    Size = mainFrame.Size,
    Position = mainFrame.Position
}

minimizeButton.MouseButton1Click:Connect(function()
    minimized = not minimized
    if minimized then
        savedFrameState.Size = mainFrame.Size
        savedFrameState.Position = mainFrame.Position
        mainFrame:TweenSize(UDim2.new(0, 340, 0, 52), Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.2, true)
    else
        mainFrame:TweenSize(savedFrameState.Size, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.2, true)
    end
end)

-- Dragging Functionality
local dragging = false
local dragStart
local startPos

mainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
    end
end)

mainFrame.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

-- Content ScrollingFrame
local content = Instance.new("ScrollingFrame")
content.Name = "Content"
content.Size = UDim2.new(1, -16, 1, -60)
content.Position = UDim2.new(0, 8, 0, 52)
content.BackgroundTransparency = 1
content.BorderSizePixel = 0
content.CanvasSize = UDim2.new(0, 0, 0, 0)
content.ScrollBarThickness = 8
content.AutomaticCanvasSize = Enum.AutomaticSize.Y
content.Parent = mainFrame

local listLayout = Instance.new("UIListLayout")
listLayout.Padding = UDim.new(0, 6)
listLayout.FillDirection = Enum.FillDirection.Vertical
listLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Parent = content

-- UI Element Creators
local function MakeButton(text)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, 0, 0, 32)
    btn.BackgroundColor3 = COLOR_BUTTON
    btn.TextColor3 = COLOR_TEXT
    btn.BorderSizePixel = 0
    btn.Text = text
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 14
    assignOrder(btn)
    return btn
end

local function MakeTextBox(text)
    local tb = Instance.new("TextBox")
    tb.Size = UDim2.new(1, 0, 0, 32)
    tb.BackgroundColor3 = COLOR_BUTTON
    tb.TextColor3 = COLOR_TEXT
    tb.BorderSizePixel = 0
    tb.Text = text
    tb.ClearTextOnFocus = false
    tb.Font = Enum.Font.Gotham
    tb.TextSize = 14
    assignOrder(tb)
    return tb
end

local function MakeLabel(text)
    local lbl = Instance.new("TextLabel")
    lbl.Size = UDim2.new(1, 0, 0, 24)
    lbl.BackgroundTransparency = 1
    lbl.TextColor3 = COLOR_TEXT
    lbl.Font = Enum.Font.GothamSemibold
    lbl.TextSize = 14
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.Text = text
    assignOrder(lbl)
    return lbl
end

local function MakeToggle(parent, label, callback)
    local btn = MakeButton(label .. " OFF")
    btn.Parent = parent
    local state = false
    
    local function updateText()
        btn.Text = label .. (state and " ON" or " OFF")
    end
    
    btn.MouseButton1Click:Connect(function()
        state = not state
        updateText()
        callback(state, btn)
    end)
    
    local function get()
        return state
    end
    
    local function set(v)
        if state == v then return end
        state = v
        updateText()
        callback(state, btn)
    end
    
    updateText()
    return btn, get, set
end

-- ===== MOVEMENT FEATURES =====
local movementLabel = MakeLabel("Movement")
movementLabel.Parent = content

-- Fly Feature
local flyConn
local flyGyro
local flyVel
local flySpeed = 50

local function ReinitFly()
    local char = LocalPlayer.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then
        hrp = char:WaitForChild("HumanoidRootPart", 5)
        if not hrp then return end
    end
    
    flyGyro = Instance.new("BodyGyro")
    flyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    flyGyro.P = 9e4
    flyGyro.CFrame = hrp.CFrame
    flyGyro.Parent = hrp
    
    flyVel = Instance.new("BodyVelocity")
    flyVel.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    flyVel.Velocity = Vector3.new(0, 0, 0)
    flyVel.Parent = hrp
    
    if flyConn then
        flyConn:Disconnect()
    end
    
    flyConn = RunService.RenderStepped:Connect(function()
        if not flyGyro or not flyVel or not hrp or not hrp.Parent then
            return
        end
        
        local cam = workspace.CurrentCamera
        if not cam then return end
        
        local cf = cam.CFrame
        flyGyro.CFrame = cf
        
        local dir = Vector3.new(0, 0, 0)
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then
            dir = dir + cf.LookVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then
            dir = dir - cf.LookVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then
            dir = dir - cf.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then
            dir = dir + cf.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
            dir = dir + cf.UpVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
            dir = dir - cf.UpVector
        end
        
        if dir.Magnitude > 0 then
            flyVel.Velocity = dir.Unit * flySpeed
        else
            flyVel.Velocity = Vector3.new(0, 0, 0)
        end
    end)
end

local flyToggleBtn, getFlyState, setFlyState = MakeToggle(content, "Fly", function(on)
    if on then
        ReinitFly()
    else
        if flyConn then
            flyConn:Disconnect()
            flyConn = nil
        end
        if flyGyro then
            flyGyro:Destroy()
            flyGyro = nil
        end
        if flyVel then
            flyVel:Destroy()
            flyVel = nil
        end
    end
end)

-- Noclip Feature
local noclipConn
local noclipToggleBtn, getNoclipState, setNoclipState = MakeToggle(content, "Noclip", function(on)
    if noclipConn then
        noclipConn:Disconnect()
        noclipConn = nil
    end
    
    if on then
        noclipConn = RunService.Stepped:Connect(function()
            local char = LocalPlayer.Character
            if not char then return end
            
            for _, part in ipairs(char:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end)
    end
end)

-- Infinite Jump Feature
local infJumpConn
local infJumpToggleBtn, getInfJumpState, setInfJumpState = MakeToggle(content, "InfiniteJump", function(on)
    if infJumpConn then
        infJumpConn:Disconnect()
        infJumpConn = nil
    end
    
    if on then
        infJumpConn = UserInputService.JumpRequest:Connect(function()
            local char = LocalPlayer.Character
            if not char then return end
            
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then
                hum:ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end)
    end
end)

-- Anti-Teleport Feature
local antiTpConn
local lastPos
local antiTpToggleBtn, getAntiTpState, setAntiTpState = MakeToggle(content, "AntiTeleport", function(on)
    if antiTpConn then
        antiTpConn:Disconnect()
        antiTpConn = nil
    end
    
    if on then
        lastPos = nil
        antiTpConn = RunService.Heartbeat:Connect(function()
            local char = LocalPlayer.Character
            if not char then return end
            
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if not hrp then return end
            
            if lastPos then
                local delta = hrp.Position - lastPos
                if delta.Magnitude > 50 then
                    hrp.CFrame = CFrame.new(lastPos)
                end
            end
            lastPos = hrp.Position
        end)
    end
end)

-- WalkSpeed Feature
local loopWsLabel = MakeLabel("Loop WalkSpeed")
loopWsLabel.Parent = content

local loopWsEnabled = false
local targetWalkSpeed = 16
local loopWsConn
local originalWalkSpeed

local wsBox = MakeTextBox("WalkSpeed: 16")
wsBox.Parent = content

wsBox.FocusLost:Connect(function()
    local val = tonumber(wsBox.Text:match("%d+"))
    if val and val > 0 then
        targetWalkSpeed = val
        wsBox.Text = "WalkSpeed: " .. targetWalkSpeed
    else
        wsBox.Text = "WalkSpeed: " .. targetWalkSpeed
    end
end)

local loopWsToggleBtn, getLoopWsState, setLoopWsState = MakeToggle(content, "LoopWalkSpeed", function(on)
    loopWsEnabled = on
    
    if loopWsConn then
        loopWsConn:Disconnect()
        loopWsConn = nil
    end
    
    local function apply()
        local char = LocalPlayer.Character
        if not char then return end
        
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then
            if on and originalWalkSpeed == nil then
                originalWalkSpeed = hum.WalkSpeed
            end
            
            if on then
                hum.WalkSpeed = targetWalkSpeed
            else
                if originalWalkSpeed ~= nil then
                    hum.WalkSpeed = originalWalkSpeed
                else
                    hum.WalkSpeed = 16
                end
            end
        end
    end
    
    if on then
        apply()
        loopWsConn = RunService.Heartbeat:Connect(apply)
    else
        local char = LocalPlayer.Character
        if char then
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum and originalWalkSpeed ~= nil then
                hum.WalkSpeed = originalWalkSpeed
            end
        end
        originalWalkSpeed = nil
    end
end)

-- ===== BTOOLS =====
local btoolsLabel = MakeLabel("BTools")
btoolsLabel.Parent = content

local undoStack = {}

local function pushUndo(entry)
    table.insert(undoStack, entry)
end

local function popUndo()
    local entry = table.remove(undoStack)
    if not entry then return end
    
    if entry.action == "delete" then
        if entry.part and entry.parent then
            pcall(function()
                entry.part.Parent = entry.parent
                if entry.part:IsA("BasePart") and entry.canCollide ~= nil then
                    entry.part.CanCollide = entry.canCollide
                end
            end)
        end
    elseif entry.action == "clone" then
        if entry.clone and entry.clone.Parent then
            pcall(function()
                entry.clone:Destroy()
            end)
        end
    elseif entry.action == "move" then
        if entry.part and entry.prevCFrame then
            pcall(function()
                entry.part.CFrame = entry.prevCFrame
            end)
        end
    end
end

local giveBToolsBtn = MakeButton("Give BTools (Delete, Clone, Undo, Move)")
giveBToolsBtn.Parent = content

local btoolsInitialized = {}

giveBToolsBtn.MouseButton1Click:Connect(function()
    local backpack = LocalPlayer:WaitForChild("Backpack")
    
    local function makeTool(name)
        for _, t in ipairs(backpack:GetChildren()) do
            if t:IsA("Tool") and t.Name == name then
                t:Destroy()
            end
        end
        
        local tool = Instance.new("Tool")
        tool.Name = name
        tool.RequiresHandle = false
        tool.Parent = backpack
        return tool
    end
    
    local deleteTool = makeTool("Delete")
    local cloneTool = makeTool("Clone")
    local undoTool = makeTool("Undo")
    local moveTool = makeTool("Move")
    
    if not btoolsInitialized["Delete"] then
        btoolsInitialized["Delete"] = true
        deleteTool.Activated:Connect(function()
            local mouse = LocalPlayer:GetMouse()
            local target = mouse.Target
            if target and target:IsA("BasePart") and target.Parent ~= workspace.Terrain then
                pushUndo({
                    action = "delete",
                    part = target,
                    parent = target.Parent,
                    canCollide = target.CanCollide
                })
                target.Parent = nil
            end
        end)
    end
    
    if not btoolsInitialized["Clone"] then
        btoolsInitialized["Clone"] = true
        cloneTool.Activated:Connect(function()
            local mouse = LocalPlayer:GetMouse()
            local target = mouse.Target
            if target and target:IsA("BasePart") then
                local ok, clone = pcall(function()
                    return target:Clone()
                end)
                
                if ok and clone then
                    local parent = target.Parent
                    if parent then
                        clone.Parent = parent
                    else
                        clone.Parent = workspace
                    end
                    
                    if clone:IsA("BasePart") then
                        clone.CFrame = clone.CFrame + Vector3.new(2, 0, 2)
                    end
                    
                    pushUndo({
                        action = "clone",
                        clone = clone
                    })
                end
            end
        end)
    end
    
    if not btoolsInitialized["Undo"] then
        btoolsInitialized["Undo"] = true
        undoTool.Activated:Connect(function()
            popUndo()
        end)
    end
    
    if not btoolsInitialized["Move"] then
        btoolsInitialized["Move"] = true
        
        local moveConn
        local downConn
        local upConn
        local selectedPart
        local prevCFrame
        
        moveTool.Equipped:Connect(function()
            local mouse = LocalPlayer:GetMouse()
            
            downConn = mouse.Button1Down:Connect(function()
                local target = mouse.Target
                if target and target:IsA("BasePart") and target.Parent ~= workspace.Terrain then
                    selectedPart = target
                    prevCFrame = selectedPart.CFrame
                    pushUndo({
                        action = "move",
                        part = selectedPart,
                        prevCFrame = prevCFrame
                    })
                    selectedPart.CanCollide = false
                    
                    moveConn = RunService.RenderStepped:Connect(function()
                        if selectedPart and selectedPart.Parent then
                            local hit = mouse.Hit
                            if hit then
                                local pos = hit.Position + Vector3.new(0, selectedPart.Size.Y / 2, 0)
                                selectedPart.CFrame = CFrame.new(pos)
                            end
                        end
                    end)
                end
            end)
            
            upConn = mouse.Button1Up:Connect(function()
                if moveConn then
                    moveConn:Disconnect()
                    moveConn = nil
                end
                if selectedPart then
                    selectedPart.CanCollide = true
                    selectedPart = nil
                end
            end)
        end)
        
        moveTool.Unequipped:Connect(function()
            if moveConn then
                moveConn:Disconnect()
                moveConn = nil
            end
            if downConn then
                downConn:Disconnect()
                downConn = nil
            end
            if upConn then
                upConn:Disconnect()
                upConn = nil
            end
            if selectedPart then
                selectedPart.CanCollide = true
                selectedPart = nil
            end
        end)
    end
end)

local localDeleteBtn = MakeButton("Enable local Delete Tool")
localDeleteBtn.Parent = content

local localDeleteConn

localDeleteBtn.MouseButton1Click:Connect(function()
    if localDeleteConn then
        localDeleteConn:Disconnect()
        localDeleteConn = nil
        localDeleteBtn.Text = "Enable local Delete Tool"
        return
    end
    
    localDeleteBtn.Text = "Disable local Delete Tool"
    localDeleteConn = UserInputService.InputBegan:Connect(function(input, gp)
        if gp then return end
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            local mouse = LocalPlayer:GetMouse()
            local target = mouse.Target
            if target and target:IsA("BasePart") and target.Parent ~= workspace.Terrain then
                pushUndo({
                    action = "delete",
                    part = target,
                    parent = target.Parent,
                    canCollide = target.CanCollide
                })
                target.Parent = nil
            end
        end
    end)
end)

local undoLastBtn = MakeButton("Undo last delete")
undoLastBtn.Parent = content

undoLastBtn.MouseButton1Click:Connect(function()
    popUndo()
end)

-- ===== PLAYER TRACER =====
local tracerLabel = MakeLabel("Player Tracer")
tracerLabel.Parent = content

local tracerState = {
    players = {},
    playerAddedConn = nil,
    playerRemovingConn = nil
}

local function getTeamColor(plr)
    if plr.Team and plr.TeamColor then
        return plr.TeamColor.Color
    end
    return Color3.new(1, 1, 1)
end

local function clearTracerForPlayer(plr)
    local data = tracerState.players[plr]
    if not data then return end
    
    if data.conn then
        data.conn:Disconnect()
        data.conn = nil
    end
    
    if data.charConn then
        data.charConn:Disconnect()
        data.charConn = nil
    end
    
    if data.gui and data.gui.Parent then
        data.gui:Destroy()
        data.gui = nil
    end
    
    tracerState.players[plr] = nil
end

local function createTracerGui(plr, char)
    if not char then return end
    
    if tracerState.players[plr] then
        if tracerState.players[plr].conn then
            tracerState.players[plr].conn:Disconnect()
        end
        if tracerState.players[plr].gui then
            tracerState.players[plr].gui:Destroy()
        end
    end
    
    local hrp = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso")
    if not hrp then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "PlayerTracerGui"
    billboard.Adornee = hrp
    billboard.Size = UDim2.new(0, 200, 0, 40)
    billboard.StudsOffset = Vector3.new(0, 2.5, 0)
    billboard.AlwaysOnTop = true
    billboard.LightInfluence = 0
    billboard.Parent = hrp
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundTransparency = 0.35
    frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    frame.BorderSizePixel = 0
    frame.Parent = billboard
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -8, 1, -8)
    label.Position = UDim2.new(0, 4, 0, 4)
    label.BackgroundTransparency = 1
    label.TextColor3 = getTeamColor(plr)
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextStrokeTransparency = 0.6
    label.Text = plr.Name
    label.TextXAlignment = Enum.TextXAlignment.Center
    label.Parent = billboard
    
    local conn
    conn = RunService.Heartbeat:Connect(function()
        if not plr or not plr.Parent then
            conn:Disconnect()
            return
        end
        
        local myChar = LocalPlayer.Character
        if not myChar or not myChar.Parent then
            label.Text = plr.Name .. " - respawning"
            return
        end
        
        local myRoot = myChar:FindFirstChild("HumanoidRootPart") or myChar:FindFirstChild("Torso") or myChar:FindFirstChild("UpperTorso")
        if not myRoot or not hrp or not hrp.Parent then
            label.Text = plr.Name .. " - unknown"
            return
        end
        
        local dist = (hrp.Position - myRoot.Position).Magnitude
        label.Text = plr.Name .. " - " .. math.floor(dist) .. " studs"
        label.TextColor3 = getTeamColor(plr)
    end)
    
    local data = tracerState.players[plr] or {}
    data.gui = billboard
    data.conn = conn
    tracerState.players[plr] = data
end

local function setupTracerForPlayer(plr)
    if plr == LocalPlayer then return end
    
    if tracerState.players[plr] and tracerState.players[plr].gui then
        return
    end
    
    if plr.Character and plr.Character.Parent then
        createTracerGui(plr, plr.Character)
    end
    
    local charConn = plr.CharacterAdded:Connect(function(char)
        task.wait(0.5)
        createTracerGui(plr, char)
    end)
    
    local data = tracerState.players[plr] or {}
    data.charConn = charConn
    tracerState.players[plr] = data
end

local tracerEnabled = false

MakeToggle(content, "Player Tracer", function(on)
    tracerEnabled = on
    
    if tracerState.playerAddedConn then
        tracerState.playerAddedConn:Disconnect()
        tracerState.playerAddedConn = nil
    end
    
    if tracerState.playerRemovingConn then
        tracerState.playerRemovingConn:Disconnect()
        tracerState.playerRemovingConn = nil
    end
    
    if on then
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer then
                setupTracerForPlayer(plr)
            end
        end
        
        tracerState.playerAddedConn = Players.PlayerAdded:Connect(function(plr)
            if tracerEnabled and plr ~= LocalPlayer then
                setupTracerForPlayer(plr)
            end
        end)
        
        tracerState.playerRemovingConn = Players.PlayerRemoving:Connect(function(plr)
            clearTracerForPlayer(plr)
        end)
    else
        for plr, _ in pairs(tracerState.players) do
            clearTracerForPlayer(plr)
        end
    end
end)

-- ===== EMOTE SYSTEM =====
local emoteLabel = MakeLabel("Emote")
emoteLabel.Parent = content

local emoteInput = MakeTextBox("Enter emote animation id")
emoteInput.Parent = content

local emoteButtonsFrame = Instance.new("Frame")
emoteButtonsFrame.Size = UDim2.new(1, 0, 0, 36)
emoteButtonsFrame.BackgroundTransparency = 1
assignOrder(emoteButtonsFrame)
emoteButtonsFrame.Parent = content

local startEmoteBtn = Instance.new("TextButton")
startEmoteBtn.Size = UDim2.new(0.48, -4, 1, 0)
startEmoteBtn.Position = UDim2.new(0, 0, 0, 0)
startEmoteBtn.BackgroundColor3 = COLOR_BUTTON
startEmoteBtn.TextColor3 = COLOR_TEXT
startEmoteBtn.Font = Enum.Font.Gotham
startEmoteBtn.TextSize = 14
startEmoteBtn.Text = "Start Emote"
startEmoteBtn.Parent = emoteButtonsFrame

local stopEmoteBtn = Instance.new("TextButton")
stopEmoteBtn.Size = UDim2.new(0.48, -4, 1, 0)
stopEmoteBtn.Position = UDim2.new(0.52, 0, 0, 0)
stopEmoteBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
stopEmoteBtn.TextColor3 = COLOR_TEXT
stopEmoteBtn.Font = Enum.Font.Gotham
stopEmoteBtn.TextSize = 14
stopEmoteBtn.Text = "Stop Emote"
stopEmoteBtn.Parent = emoteButtonsFrame

local savedEmoteLabel = MakeLabel("Saved Emote")
savedEmoteLabel.Parent = content

local savedEmoteBox = MakeTextBox("")
savedEmoteBox.Parent = content

local emoteStatusLabel = Instance.new("TextLabel")
emoteStatusLabel.Size = UDim2.new(1, 0, 0, 20)
emoteStatusLabel.BackgroundTransparency = 1
emoteStatusLabel.TextColor3 = COLOR_TEXT
emoteStatusLabel.Font = Enum.Font.Gotham
emoteStatusLabel.TextSize = 12
emoteStatusLabel.TextXAlignment = Enum.TextXAlignment.Left
emoteStatusLabel.Text = ""
assignOrder(emoteStatusLabel)
emoteStatusLabel.Parent = content

local savedButtonsFrame = Instance.new("Frame")
savedButtonsFrame.Size = UDim2.new(1, 0, 0, 36)
savedButtonsFrame.BackgroundTransparency = 1
assignOrder(savedButtonsFrame)
savedButtonsFrame.Parent = content

local saveEmoteBtn = Instance.new("TextButton")
saveEmoteBtn.Size = UDim2.new(0.48, -4, 1, 0)
saveEmoteBtn.Position = UDim2.new(0, 0, 0, 0)
saveEmoteBtn.BackgroundColor3 = Color3.fromRGB(60, 180, 90)
saveEmoteBtn.TextColor3 = COLOR_TEXT
saveEmoteBtn.Font = Enum.Font.Gotham
saveEmoteBtn.TextSize = 14
saveEmoteBtn.Text = "Save Emote"
saveEmoteBtn.Parent = savedButtonsFrame

local removeSavedBtn = Instance.new("TextButton")
removeSavedBtn.Size = UDim2.new(0.48, -4, 1, 0)
removeSavedBtn.Position = UDim2.new(0.52, 0, 0, 0)
removeSavedBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
removeSavedBtn.TextColor3 = COLOR_TEXT
removeSavedBtn.Font = Enum.Font.Gotham
removeSavedBtn.TextSize = 14
removeSavedBtn.Text = "Remove Saved"
removeSavedBtn.Parent = savedButtonsFrame

local currentEmoteTrack = nil
local currentEmoteAnim = nil

local function stopEmote()
    if currentEmoteTrack then
        pcall(function()
            currentEmoteTrack:Stop()
        end)
        currentEmoteTrack = nil
    end
    if currentEmoteAnim then
        pcall(function()
            currentEmoteAnim:Destroy()
        end)
        currentEmoteAnim = nil
    end
    emoteStatusLabel.Text = "‚õî Emote stopped"
end

local function playEmote(idStr)
    if not idStr or idStr == "" then
        emoteStatusLabel.Text = "‚ùå No ID entered"
        return
    end
    
    local idNum = tonumber(idStr)
    if not idNum then
        emoteStatusLabel.Text = "‚ùå Invalid ID format"
        return
    end
    
    local char = LocalPlayer.Character
    if not char then
        emoteStatusLabel.Text = "‚ùå No character found"
        return
    end
    
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then
        emoteStatusLabel.Text = "‚ùå No humanoid found"
        return
    end
    
    stopEmote()
    
    local anim = Instance.new("Animation")
    anim.Name = "EmoteAnim"
    anim.AnimationId = "rbxassetid://" .. tostring(idNum)
    anim.Parent = char
    currentEmoteAnim = anim
    
    local ok, track = pcall(function()
        return hum:LoadAnimation(anim)
    end)
    
    if ok and track then
        currentEmoteTrack = track
        track.Priority = Enum.AnimationPriority.Action
        track:Play()
        emoteStatusLabel.Text = "‚úÖ Emote playing"
    else
        emoteStatusLabel.Text = "‚ùå Failed to load animation"
        if anim and anim.Parent then
            anim:Destroy()
        end
        currentEmoteAnim = nil
        currentEmoteTrack = nil
    end
end

startEmoteBtn.MouseButton1Click:Connect(function()
    local id = emoteInput.Text:match("%d+")
    if id and id ~= "" then
        playEmote(id)
    else
        emoteStatusLabel.Text = "‚ùå Enter a valid ID"
    end
end)

stopEmoteBtn.MouseButton1Click:Connect(function()
    stopEmote()
end)

saveEmoteBtn.MouseButton1Click:Connect(function()
    local id = emoteInput.Text:match("%d+")
    if id and id ~= "" then
        savedEmoteBox.Text = id
        emoteStatusLabel.Text = "üíæ Emote saved"
    else
        emoteStatusLabel.Text = "‚ùå Invalid ID"
    end
end)

removeSavedBtn.MouseButton1Click:Connect(function()
    savedEmoteBox.Text = ""
    emoteStatusLabel.Text = "üóëÔ∏è Saved emote removed"
end)

-- ===== SIDE DODGE =====
local sideDodgeLabel = MakeLabel("Side Dodge (Q/E)")
sideDodgeLabel.Parent = content

local sideDodgeConn
local sideDodgeEnabled = false
local dodgeDuration = 0.15
local dodgeSpeed = 80

MakeToggle(content, "Side Dodge", function(on)
    sideDodgeEnabled = on
    
    if sideDodgeConn then
        sideDodgeConn:Disconnect()
        sideDodgeConn = nil
    end
    
    if on then
        sideDodgeConn = UserInputService.InputBegan:Connect(function(input, gp)
            if gp then return end
            if input.UserInputType ~= Enum.UserInputType.Keyboard then return end
            
            local key = input.KeyCode
            if key ~= Enum.KeyCode.Q and key ~= Enum.KeyCode.E then return end
            
            local char = LocalPlayer.Character
            if not char then return end
            
            local hrp = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso")
            if not hrp then return end
            
            local hum = char:FindFirstChildOfClass("Humanoid")
            if not hum then return end
            
            local cam = workspace.CurrentCamera
            local right
            if cam then
                right = cam.CFrame.RightVector
            else
                right = hrp.CFrame.RightVector
            end
            
            local dir
            if key == Enum.KeyCode.E then
                dir = right
            else
                dir = Vector3.new(-right.X, -right.Y, -right.Z)
            end
            
            dir = Vector3.new(dir.X, 0, dir.Z)
            if dir.Magnitude == 0 then return end
            dir = dir.Unit
            
            local bv = Instance.new("BodyVelocity")
            bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
            bv.Velocity = dir * dodgeSpeed
            bv.P = 1250
            bv.Parent = hrp
            
            local oldWs = hum.WalkSpeed
            if oldWs < dodgeSpeed then
                hum.WalkSpeed = dodgeSpeed
            end
            
            task.delay(dodgeDuration, function()
                if bv and bv.Parent then
                    bv:Destroy()
                end
                if hum and hum.Parent then
                    hum.WalkSpeed = oldWs
                end
            end)
        end)
    end
end)

-- ===== PLAYER TELEPORT =====
local tpLabel = MakeLabel("Teleport to Player")
tpLabel.Parent = content

local tpInput = MakeTextBox("Type username")
tpInput.Parent = content

local tpButtonsFrame = Instance.new("Frame")
tpButtonsFrame.Size = UDim2.new(1, 0, 0, 36)
tpButtonsFrame.BackgroundTransparency = 1
assignOrder(tpButtonsFrame)
tpButtonsFrame.Parent = content

local tpButton = Instance.new("TextButton")
tpButton.Size = UDim2.new(0.48, -4, 1, 0)
tpButton.Position = UDim2.new(0, 0, 0, 0)
tpButton.BackgroundColor3 = Color3.fromRGB(60, 180, 90)
tpButton.TextColor3 = COLOR_TEXT
tpButton.Font = Enum.Font.Gotham
tpButton.TextSize = 14
tpButton.Text = "Teleport"
tpButton.Parent = tpButtonsFrame

local tpClosestButton = Instance.new("TextButton")
tpClosestButton.Size = UDim2.new(0.48, -4, 1, 0)
tpClosestButton.Position = UDim2.new(0.52, 0, 0, 0)
tpClosestButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
tpClosestButton.TextColor3 = COLOR_TEXT
tpClosestButton.Font = Enum.Font.Gotham
tpClosestButton.TextSize = 14
tpClosestButton.Text = "TP Closest Match"
tpClosestButton.Parent = tpButtonsFrame

local function findMatchingPlayers(partial)
    partial = partial:lower()
    local matches = {}
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            local uname = plr.Name:lower()
            local dname = (plr.DisplayName or ""):lower()
            if uname:find(partial, 1, true) or dname:find(partial, 1, true) then
                table.insert(matches, plr)
            end
        end
    end
    return matches
end

local function teleportToPlayer(plr)
    local char = LocalPlayer.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    local targetChar = plr.Character
    if not targetChar then return end
    
    local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return end
    
    hrp.CFrame = targetRoot.CFrame + Vector3.new(0, 3, 0)
end

tpButton.MouseButton1Click:Connect(function()
    local text = tpInput.Text
    if not text or text == "" then return end
    
    local matches = findMatchingPlayers(text)
    if #matches >= 1 then
        teleportToPlayer(matches[1])
    end
end)

tpClosestButton.MouseButton1Click:Connect(function()
    local text = tpInput.Text
    if not text or text == "" then return end
    
    local matches = findMatchingPlayers(text)
    if #matches == 0 then return end
    
    local char = LocalPlayer.Character
    if not char then
        teleportToPlayer(matches[1])
        return
    end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then
        teleportToPlayer(matches[1])
        return
    end
    
    local closestPlr = nil
    local closestDist = math.huge
    for _, plr in ipairs(matches) do
        local tChar = plr.Character
        if tChar then
            local tRoot = tChar:FindFirstChild("HumanoidRootPart")
            if tRoot then
                local dist = (tRoot.Position - hrp.Position).Magnitude
                if dist < closestDist then
                    closestDist = dist
                    closestPlr = plr
                end
            end
        end
    end
    
    if closestPlr then
        teleportToPlayer(closestPlr)
    end
end)

-- ===== CLIENT LOGGER =====
local loggerLabel = MakeLabel("Client Logger")
loggerLabel.Parent = content

local loggerGui
local loggerScroll
local loggerDragging = false
local loggerDragStart
local loggerStartPos
local loggerHooks = {}
local loggerRemoteOldInvoke = {}
local loggerOldPrint, loggerOldWarn, loggerOldError
local loggerEnabled = false
local filter_prints = true
local filter_remotes = true
local filter_functions = true
local filter_physics = true
local filter_ui = true
local filter_localscripts = true

local function CreateLoggerGui()
    loggerGui = Instance.new("Frame")
    loggerGui.Name = "ClientLoggerWindow"
    loggerGui.Size = UDim2.new(0, 460, 0, 300)
    loggerGui.Position = UDim2.new(0, 380, 0, 100)
    loggerGui.BackgroundColor3 = COLOR_BG_DARK
    loggerGui.BorderSizePixel = 0
    loggerGui.Active = true
    loggerGui.Visible = false
    loggerGui.Parent = screenGui
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 24)
    title.BackgroundColor3 = COLOR_PRIMARY
    title.BorderSizePixel = 0
    title.Text = "Client-side Event/Script Logger"
    title.TextColor3 = COLOR_TEXT
    title.Font = Enum.Font.GothamBold
    title.TextSize = 14
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = loggerGui
    
    local pad = Instance.new("UIPadding")
    pad.PaddingLeft = UDim.new(0, 6)
    pad.Parent = title
    
    local filterFrame = Instance.new("Frame")
    filterFrame.Size = UDim2.new(1, -10, 0, 30)
    filterFrame.Position = UDim2.new(0, 5, 0, 26)
    filterFrame.BackgroundTransparency = 1
    filterFrame.Parent = loggerGui
    
    local filterLayout = Instance.new("UIListLayout")
    filterLayout.FillDirection = Enum.FillDirection.Horizontal
    filterLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
    filterLayout.VerticalAlignment = Enum.VerticalAlignment.Center
    filterLayout.Padding = UDim.new(0, 6)
    filterLayout.Parent = filterFrame
    
    local function MakeFilterToggle(text, default, callback)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, 65, 0, 24)
        btn.BackgroundColor3 = COLOR_BUTTON
        btn.TextColor3 = COLOR_TEXT
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 12
        btn.BorderSizePixel = 0
        local state = default
        local function update()
            btn.Text = text .. (state and " ON" or " OFF")
        end
        update()
        btn.MouseButton1Click:Connect(function()
            state = not state
            update()
            callback(state)
        end)
        btn.Parent = filterFrame
        return btn
    end
    
    MakeFilterToggle("Print", true, function(v) filter_prints = v end)
    MakeFilterToggle("Remote", true, function(v) filter_remotes = v end)
    MakeFilterToggle("Func", true, function(v) filter_functions = v end)
    MakeFilterToggle("Phys", true, function(v) filter_physics = v end)
    MakeFilterToggle("UI", true, function(v) filter_ui = v end)
    MakeFilterToggle("Script", true, function(v) filter_localscripts = v end)
    
    local clearBtn = Instance.new("TextButton")
    clearBtn.Size = UDim2.new(0, 50, 0, 24)
    clearBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
    clearBtn.TextColor3 = COLOR_TEXT
    clearBtn.Font = Enum.Font.GothamBold
    clearBtn.TextSize = 12
    clearBtn.Text = "CLEAR"
    clearBtn.BorderSizePixel = 0
    clearBtn.Parent = filterFrame
    
    clearBtn.MouseButton1Click:Connect(function()
        if loggerScroll then
            for _, child in ipairs(loggerScroll:GetChildren()) do
                if child:IsA("TextLabel") then
                    child:Destroy()
                end
            end
        end
    end)
    
    loggerScroll = Instance.new("ScrollingFrame")
    loggerScroll.Size = UDim2.new(1, -10, 1, -66)
    loggerScroll.Position = UDim2.new(0, 5, 0, 60)
    loggerScroll.BackgroundTransparency = 1
    loggerScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    loggerScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
    loggerScroll.ScrollBarThickness = 6
    loggerScroll.Parent = loggerGui
    
    local layout = Instance.new("UIListLayout")
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0, 2)
    layout.Parent = loggerScroll
    
    title.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            loggerDragging = true
            loggerDragStart = input.Position
            loggerStartPos = loggerGui.Position
        end
    end)
    
    title.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            loggerDragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if loggerDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - loggerDragStart
            loggerGui.Position = UDim2.new(
                loggerStartPos.X.Scale,
                loggerStartPos.X.Offset + delta.X,
                loggerStartPos.Y.Scale,
                loggerStartPos.Y.Offset + delta.Y
            )
        end
    end)
end

CreateLoggerGui()

local function Log(msg, category)
    if not loggerEnabled or not loggerScroll then return end
    
    if category == "print" and not filter_prints then return end
    if category == "remote" and not filter_remotes then return end
    if category == "function" and not filter_functions then return end
    if category == "physics" and not filter_physics then return end
    if category == "ui" and not filter_ui then return end
    if category == "localscript" and not filter_localscripts then return end
    
    local line = Instance.new("TextLabel")
    line.Size = UDim2.new(1, -4, 0, 18)
    line.BackgroundTransparency = 1
    line.TextColor3 = COLOR_TEXT
    line.Font = Enum.Font.Code
    line.TextSize = 13
    line.TextXAlignment = Enum.TextXAlignment.Left
    line.Text = msg
    line.TextWrapped = false
    line.TextTruncate = Enum.TextTruncate.AtEnd
    line.Parent = loggerScroll
end

local function HookPrints()
    if loggerOldPrint then return end
    
    loggerOldPrint = print
    loggerOldWarn = warn
    
    getgenv().print = function(...)
        loggerOldPrint(...)
        local args = {...}
        local msg = ""
        for i, v in ipairs(args) do
            msg = msg .. tostring(v) .. (i < #args and " " or "")
        end
        Log("[PRINT] " .. msg, "print")
    end
    
    getgenv().warn = function(...)
        loggerOldWarn(...)
        local args = {...}
        local msg = ""
        for i, v in ipairs(args) do
            msg = msg .. tostring(v) .. (i < #args and " " or "")
        end
        Log("[WARN] " .. msg, "print")
    end
end

local function HookRemotes()
    local function hookRemote(obj)
        if obj:IsA("RemoteEvent") then
            local c = obj.OnClientEvent:Connect(function(...)
                local args = {...}
                local argStr = ""
                for i, v in ipairs(args) do
                    argStr = argStr .. tostring(v) .. (i < #args and ", " or "")
                end
                Log("[RemoteEvent] " .. obj:GetFullName() .. " (" .. argStr .. ")", "remote")
            end)
            table.insert(loggerHooks, function()
                c:Disconnect()
            end)
        elseif obj:IsA("RemoteFunction") then
            if not loggerRemoteOldInvoke[obj] then
                loggerRemoteOldInvoke[obj] = obj.OnClientInvoke
                obj.OnClientInvoke = function(...)
                    Log("[RemoteFunction] " .. obj:GetFullName(), "function")
                    if loggerRemoteOldInvoke[obj] then
                        return loggerRemoteOldInvoke[obj](...)
                    end
                end
                table.insert(loggerHooks, function()
                    if loggerRemoteOldInvoke[obj] then
                        obj.OnClientInvoke = loggerRemoteOldInvoke[obj]
                    end
                end)
            end
        end
    end
    
    for _, obj in ipairs(game:GetDescendants()) do
        pcall(function()
            hookRemote(obj)
        end)
    end
    
    local c = game.DescendantAdded:Connect(function(obj)
        pcall(function()
            hookRemote(obj)
        end)
    end)
    table.insert(loggerHooks, function()
        c:Disconnect()
    end)
end

local function HookLocalScripts()
    local function hookScript(obj)
        if obj:IsA("LocalScript") then
            Log("[LocalScript Added] " .. obj:GetFullName(), "localscript")
            
            local propConn = obj:GetPropertyChangedSignal("Enabled"):Connect(function()
                Log("[LocalScript Toggled] " .. obj:GetFullName() .. " Enabled=" .. tostring(obj.Enabled), "localscript")
            end)
            table.insert(loggerHooks, function()
                propConn:Disconnect()
            end)
        end
    end
    
    for _, obj in ipairs(game:GetDescendants()) do
        pcall(function()
            hookScript(obj)
        end)
    end
    
    local addedConn = game.DescendantAdded:Connect(function(obj)
        pcall(function()
            hookScript(obj)
        end)
    end)
    
    local removedConn = game.DescendantRemoving:Connect(function(obj)
        if obj:IsA("LocalScript") then
            Log("[LocalScript Removed] " .. obj:GetFullName(), "localscript")
        end
    end)
    
    table.insert(loggerHooks, function()
        addedConn:Disconnect()
        removedConn:Disconnect()
    end)
end

local function EnableLogger()
    if loggerEnabled then return end
    loggerEnabled = true
    loggerGui.Visible = true
    
    for _, fn in ipairs(loggerHooks) do
        pcall(fn)
    end
    loggerHooks = {}
    
    Log("Logger enabled", "print")
    HookPrints()
    HookRemotes()
    HookLocalScripts()
end

local function DisableLogger()
    if not loggerEnabled then return end
    loggerEnabled = false
    loggerGui.Visible = false
    
    for _, fn in ipairs(loggerHooks) do
        pcall(fn)
    end
    loggerHooks = {}
    
    for obj, old in pairs(loggerRemoteOldInvoke) do
        pcall(function()
            obj.OnClientInvoke = old
        end)
    end
    loggerRemoteOldInvoke = {}
    
    if loggerOldPrint then
        getgenv().print = loggerOldPrint
        getgenv().warn = loggerOldWarn
        loggerOldPrint, loggerOldWarn, loggerOldError = nil, nil, nil
    end
end

MakeToggle(content, "Logger", function(on)
    if on then
        EnableLogger()
    else
        DisableLogger()
    end
end)

-- ===== DEX EXPLORER =====
local dexLabel = MakeLabel("Dex Explorer")
dexLabel.Parent = content

local dexButton = MakeButton("Open Dex")
dexButton.Parent = content

dexButton.MouseButton1Click:Connect(function()
    task.spawn(function()
        local url = "https://raw.githubusercontent.com/infyiff/backup/main/dex.lua"
        local success, src = pcall(function()
            return game:HttpGet(url)
        end)
        if success and src then
            loadstring(src)()
        end
    end)
end)

-- ===== TOPK3K GUI =====
local topk3kLabel = MakeLabel("Topk3k Client")
topk3kLabel.Parent = content

local topk3kButton = MakeButton("Open fujiwarasayo's topk3k")
topk3kButton.Parent = content

-- Create Topk3k GUI
local Topk3kGui
local Topk3kBase
local Topk3kVisible = false

local function CreateTopk3kGui()
    if Topk3kGui then return end
    
    Topk3kGui = Instance.new("ScreenGui")
    Topk3kGui.Name = "Topk3kGui"
    Topk3kGui.ResetOnSpawn = false
    safeParent(Topk3kGui)
    
    Topk3kBase = Instance.new("Frame")
    Topk3kBase.Name = "Base"
    Topk3kBase.Size = UDim2.new(0, 500, 0, 400)
    Topk3kBase.Position = UDim2.new(0.5, -250, 0.5, -200)
    Topk3kBase.BackgroundColor3 = Color3.fromRGB(14, 23, 29)
    Topk3kBase.BorderColor3 = Color3.fromRGB(4, 7, 9)
    Topk3kBase.BorderSizePixel = 2
    Topk3kBase.Active = true
    Topk3kBase.Visible = false
    Topk3kBase.Parent = Topk3kGui
    
    -- Top Bar
    local Top = Instance.new("Frame")
    Top.Name = "Top"
    Top.Size = UDim2.new(1, -20, 0, 30)
    Top.Position = UDim2.new(0, 10, 0, 10)
    Top.BackgroundColor3 = Color3.fromRGB(7, 11, 15)
    Top.BackgroundTransparency = 0.5
    Top.BorderColor3 = Color3.fromRGB(62, 62, 62)
    Top.Parent = Topk3kBase
    
    local First = Instance.new("TextLabel")
    First.Name = "First"
    First.Size = UDim2.new(0.7, 0, 1, 0)
    First.BackgroundTransparency = 1
    First.Font = Enum.Font.SourceSansBold
    First.TextSize = 16
    First.Text = "  fujiwarasayo's T0PK3K"
    First.TextColor3 = Color3.fromRGB(184, 7, 54)
    First.TextStrokeTransparency = 0
    First.TextXAlignment = Enum.TextXAlignment.Left
    First.Parent = Top
    
    local Second = Instance.new("TextLabel")
    Second.Name = "Second"
    Second.Size = UDim2.new(0.3, 0, 1, 0)
    Second.Position = UDim2.new(0.7, 0, 0, 0)
    Second.BackgroundTransparency = 1
    Second.Font = Enum.Font.SourceSansBold
    Second.TextSize = 16
    Second.Text = "Client Edition"
    Second.TextColor3 = Color3.fromRGB(184, 7, 54)
    Second.TextStrokeTransparency = 0
    Second.TextXAlignment = Enum.TextXAlignment.Right
    Second.Parent = Top
    
    local Exit = Instance.new("TextButton")
    Exit.Name = "Exit"
    Exit.Size = UDim2.new(0, 25, 0, 25)
    Exit.Position = UDim2.new(1, -26, 0.5, -12.5)
    Exit.BackgroundColor3 = Color3.fromRGB(184, 7, 54)
    Exit.BorderSizePixel = 0
    Exit.Font = Enum.Font.SourceSansBold
    Exit.TextSize = 14
    Exit.Text = "X"
    Exit.TextColor3 = Color3.new(1, 1, 1)
    Exit.Parent = Top
    
    Exit.MouseButton1Click:Connect(function()
        Topk3kBase.Visible = false
        Topk3kVisible = false
    end)
    
    -- Dragging
    local dragging = false
    local dragStart
    local startPos
    
    Top.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = Topk3kBase.Position
        end
    end)
    
    Top.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            Topk3kBase.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    -- Main Container
    local MainContainer = Instance.new("ScrollingFrame")
    MainContainer.Name = "MainContainer"
    MainContainer.Size = UDim2.new(1, -20, 1, -60)
    MainContainer.Position = UDim2.new(0, 10, 0, 50)
    MainContainer.BackgroundColor3 = Color3.fromRGB(7, 11, 15)
    MainContainer.BackgroundTransparency = 0.5
    MainContainer.BorderColor3 = Color3.fromRGB(62, 62, 62)
    MainContainer.ScrollBarThickness = 5
    MainContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
    MainContainer.AutomaticCanvasSize = Enum.AutomaticSize.Y
    MainContainer.Parent = Topk3kBase
    
    -- Layout for main container
    local MainLayout = Instance.new("UIListLayout")
    MainLayout.Padding = UDim.new(0, 8)
    MainLayout.Parent = MainContainer
    
    local Padding = Instance.new("UIPadding")
    Padding.PaddingLeft = UDim.new(0, 8)
    Padding.PaddingRight = UDim.new(0, 8)
    Padding.PaddingTop = UDim.new(0, 8)
    Padding.PaddingBottom = UDim.new(0, 8)
    Padding.Parent = MainContainer
    
    -- Helper functions for Topk3k UI
    local function MakeTopk3kLabel(text)
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 0, 24)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.SourceSansBold
        label.TextSize = 16
        label.Text = text
        label.TextColor3 = Color3.fromRGB(184, 7, 54)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = MainContainer
        return label
    end
    
    local function MakeTopk3kRowContainer()
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, 0, 0, 32)
        container.BackgroundTransparency = 1
        container.Parent = MainContainer
        
        local layout = Instance.new("UIListLayout")
        layout.FillDirection = Enum.FillDirection.Horizontal
        layout.HorizontalAlignment = Enum.HorizontalAlignment.Left
        layout.VerticalAlignment = Enum.VerticalAlignment.Center
        layout.Padding = UDim.new(0, 8)
        layout.Parent = container
        
        return container
    end
    
    local function MakeTopk3kTextBox(widthPercent, placeholder)
        local textbox = Instance.new("TextBox")
        textbox.Size = UDim2.new(widthPercent, -4, 0, 28)
        textbox.BackgroundColor3 = Color3.fromRGB(5, 8, 11)
        textbox.BorderColor3 = Color3.fromRGB(27, 42, 53)
        textbox.Font = Enum.Font.SourceSans
        textbox.TextSize = 14
        textbox.Text = placeholder
        textbox.PlaceholderText = placeholder
        textbox.TextColor3 = Color3.fromRGB(199, 199, 199)
        textbox.ClearTextOnFocus = false
        return textbox
    end
    
    local function MakeTopk3kButton(widthPercent, text, callback)
        local button = Instance.new("TextButton")
        button.Size = UDim2.new(widthPercent, -4, 0, 28)
        button.BackgroundColor3 = Color3.fromRGB(15, 23, 30)
        button.BorderColor3 = Color3.fromRGB(27, 42, 53)
        button.Font = Enum.Font.SourceSans
        button.TextSize = 14
        button.Text = text
        button.TextColor3 = Color3.fromRGB(199, 199, 199)
        button.TextStrokeTransparency = 0.5
        
        button.MouseButton1Click:Connect(callback)
        return button
    end
    
    -- Movement Section (FIXED - Aligned horizontally)
    MakeTopk3kLabel("[ Movement ]")
    
    -- WalkSpeed Row
    local wsRow = MakeTopk3kRowContainer()
    local wsInput = MakeTopk3kTextBox(0.25, "16")
    wsInput.Parent = wsRow
    local wsButton = MakeTopk3kButton(0.75, "Set WalkSpeed", function()
        local val = tonumber(wsInput.Text)
        if val and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.WalkSpeed = val
        end
    end)
    wsButton.Parent = wsRow
    
    -- JumpPower Row
    local jpRow = MakeTopk3kRowContainer()
    local jpInput = MakeTopk3kTextBox(0.25, "50")
    jpInput.Parent = jpRow
    local jpButton = MakeTopk3kButton(0.75, "Set JumpPower", function()
        local val = tonumber(jpInput.Text)
        if val and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.JumpPower = val
        end
    end)
    jpButton.Parent = jpRow
    
    -- HipHeight Row
    local hhRow = MakeTopk3kRowContainer()
    local hhInput = MakeTopk3kTextBox(0.25, "0")
    hhInput.Parent = hhRow
    local hhButton = MakeTopk3kButton(0.75, "Set HipHeight", function()
        local val = tonumber(hhInput.Text)
        if val and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.HipHeight = val
        end
    end)
    hhButton.Parent = hhRow
    
    -- Quick Actions Row
    local quickRow = MakeTopk3kRowContainer()
    local sitButton = MakeTopk3kButton(0.33, "Sit", function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.Sit = true
        end
    end)
    sitButton.Parent = quickRow
    
    local jumpButton = MakeTopk3kButton(0.33, "Jump", function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.Jump = true
        end
    end)
    jumpButton.Parent = quickRow
    
    local platformButton = MakeTopk3kButton(0.33, "Platform Stand", function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.PlatformStand = not LocalPlayer.Character.Humanoid.PlatformStand
        end
    end)
    platformButton.Parent = quickRow
    
    -- Character Visual Section
    MakeTopk3kLabel("[ Character Visual ]")
    
    -- Visibility Row
    local visRow = MakeTopk3kRowContainer()
    local invisButton = MakeTopk3kButton(0.5, "Invisible", function()
        if LocalPlayer.Character then
            for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                if part:IsA("BasePart") or part:IsA("MeshPart") then
                    part.Transparency = 1
                end
                if part:IsA("Decal") then
                    part.Transparency = 1
                end
            end
        end
    end)
    invisButton.Parent = visRow
    
    local visButton = MakeTopk3kButton(0.5, "Visible", function()
        if LocalPlayer.Character then
            for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                    part.Transparency = 0
                elseif part:IsA("MeshPart") then
                    part.Transparency = 0
                end
                if part:IsA("Decal") then
                    part.Transparency = 0
                end
            end
        end
    end)
    visButton.Parent = visRow
    
    -- Head Size Row
    local headRow = MakeTopk3kRowContainer()
    local bigHeadButton = MakeTopk3kButton(0.33, "Big Head", function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head") and LocalPlayer.Character.Head:FindFirstChild("Mesh") then
            LocalPlayer.Character.Head.Mesh.Scale = Vector3.new(5, 5, 5)
        end
    end)
    bigHeadButton.Parent = headRow
    
    local normalHeadButton = MakeTopk3kButton(0.33, "Normal Head", function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head") and LocalPlayer.Character.Head:FindFirstChild("Mesh") then
            LocalPlayer.Character.Head.Mesh.Scale = Vector3.new(1.25, 1.25, 1.25)
        end
    end)
    normalHeadButton.Parent = headRow
    
    local tinyHeadButton = MakeTopk3kButton(0.33, "Tiny Head", function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head") and LocalPlayer.Character.Head:FindFirstChild("Mesh") then
            LocalPlayer.Character.Head.Mesh.Scale = Vector3.new(0.5, 0.5, 0.5)
        end
    end)
    tinyHeadButton.Parent = headRow
    
    -- Color and Material Row
    MakeTopk3kLabel("[ Color & Material ]")
    
    local colorRow = MakeTopk3kRowContainer()
    local colorInput = MakeTopk3kTextBox(0.25, "Bright red")
    colorInput.Parent = colorRow
    local colorButton = MakeTopk3kButton(0.75, "Set Color", function()
        if LocalPlayer.Character then
            local color = BrickColor.new(colorInput.Text)
            for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                if part:IsA("BasePart") or part:IsA("MeshPart") then
                    part.BrickColor = color
                end
            end
        end
    end)
    colorButton.Parent = colorRow
    
    local matRow = MakeTopk3kRowContainer()
    local matInput = MakeTopk3kTextBox(0.25, "Neon")
    matInput.Parent = matRow
    local matButton = MakeTopk3kButton(0.75, "Set Material", function()
        if LocalPlayer.Character then
            for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                if part:IsA("BasePart") or part:IsA("MeshPart") then
                    pcall(function()
                        part.Material = Enum.Material[matInput.Text]
                    end)
                end
            end
        end
    end)
    matButton.Parent = matRow
    
    -- Effects Section
    MakeTopk3kLabel("[ Effects ]")
    
    local effectsRow1 = MakeTopk3kRowContainer()
    local fireButton = MakeTopk3kButton(0.33, "Fire", function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            Instance.new("Fire", LocalPlayer.Character.HumanoidRootPart)
        end
    end)
    fireButton.Parent = effectsRow1
    
    local sparklesButton = MakeTopk3kButton(0.33, "Sparkles", function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            Instance.new("Sparkles", LocalPlayer.Character.HumanoidRootPart)
        end
    end)
    sparklesButton.Parent = effectsRow1
    
    local smokeButton = MakeTopk3kButton(0.33, "Smoke", function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            Instance.new("Smoke", LocalPlayer.Character.HumanoidRootPart)
        end
    end)
    smokeButton.Parent = effectsRow1
    
    local effectsRow2 = MakeTopk3kRowContainer()
    local lightButton = MakeTopk3kButton(0.33, "PointLight", function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local light = Instance.new("PointLight", LocalPlayer.Character.HumanoidRootPart)
            light.Brightness = 5
            light.Range = 20
        end
    end)
    lightButton.Parent = effectsRow2
    
    local highlightButton = MakeTopk3kButton(0.33, "Highlight", function()
        if LocalPlayer.Character then
            local highlight = Instance.new("Highlight", LocalPlayer.Character)
            highlight.FillColor = Color3.fromRGB(255, 0, 0)
            highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        end
    end)
    highlightButton.Parent = effectsRow2
    
    local removeEffectsButton = MakeTopk3kButton(0.33, "Remove Effects", function()
        if LocalPlayer.Character then
            for _, obj in pairs(LocalPlayer.Character:GetDescendants()) do
                if obj:IsA("Fire") or obj:IsA("Sparkles") or obj:IsA("Smoke") or obj:IsA("PointLight") or obj:IsA("ParticleEmitter") or obj:IsA("Highlight") then
                    obj:Destroy()
                end
            end
        end
    end)
    removeEffectsButton.Parent = effectsRow2
    
    -- Utility Section
    MakeTopk3kLabel("[ Utility ]")
    
    local utilRow1 = MakeTopk3kRowContainer()
    local rejoinButton = MakeTopk3kButton(0.5, "Rejoin Server", function()
        game:GetService("TeleportService"):TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer)
    end)
    rejoinButton.Parent = utilRow1
    
    local copyJobButton = MakeTopk3kButton(0.5, "Copy JobId", function()
        setclipboard(game.JobId)
    end)
    copyJobButton.Parent = utilRow1
    
    local utilRow2 = MakeTopk3kRowContainer()
    local copyUserIdButton = MakeTopk3kButton(0.5, "Copy User ID", function()
        setclipboard(tostring(LocalPlayer.UserId))
    end)
    copyUserIdButton.Parent = utilRow2
    
    local removeToolsButton = MakeTopk3kButton(0.5, "Remove Tools", function()
        if LocalPlayer.Backpack then
            for _, tool in pairs(LocalPlayer.Backpack:GetChildren()) do
                tool:Destroy()
            end
        end
        if LocalPlayer.Character then
            for _, tool in pairs(LocalPlayer.Character:GetChildren()) do
                if tool:IsA("Tool") then
                    tool:Destroy()
                end
            end
        end
    end)
    removeToolsButton.Parent = utilRow2
    
    -- Chat Section
    MakeTopk3kLabel("[ Chat ]")
    
    local chatRow = MakeTopk3kRowContainer()
    local chatInput = MakeTopk3kTextBox(0.5, "Message")
    chatInput.Parent = chatRow
    local chatButton = MakeTopk3kButton(0.5, "Chat", function()
        game:GetService("ReplicatedStorage").DefaultChatSystemChatEvents.SayMessageRequest:FireServer(chatInput.Text, "All")
    end)
    chatButton.Parent = chatRow
end

topk3kButton.MouseButton1Click:Connect(function()
    CreateTopk3kGui()
    Topk3kVisible = not Topk3kVisible
    Topk3kBase.Visible = Topk3kVisible
end)

-- ===== CHARACTER RESPAWN HANDLER =====
local function OnCharacterAdded(char)
    task.wait(0.1)
    
    if getFlyState and getFlyState() then
        ReinitFly()
    end
    
    if getNoclipState and getNoclipState() then
        if noclipConn then
            noclipConn:Disconnect()
            noclipConn = nil
        end
        noclipConn = RunService.Stepped:Connect(function()
            local c = LocalPlayer.Character
            if not c then return end
            
            for _, part in ipairs(c:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end)
    end
    
    if getInfJumpState and getInfJumpState() then
        if infJumpConn then
            infJumpConn:Disconnect()
            infJumpConn = nil
        end
        infJumpConn = UserInputService.JumpRequest:Connect(function()
            local c = LocalPlayer.Character
            if not c then return end
            
            local hum = c:FindFirstChildOfClass("Humanoid")
            if hum then
                hum:ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end)
    end
    
    if getAntiTpState and getAntiTpState() then
        if antiTpConn then
            antiTpConn:Disconnect()
            antiTpConn = nil
        end
        lastPos = nil
        antiTpConn = RunService.Heartbeat:Connect(function()
            local c = LocalPlayer.Character
            if not c then return end
            
            local hrp = c:FindFirstChild("HumanoidRootPart")
            if not hrp then return end
            
            if lastPos then
                local delta = hrp.Position - lastPos
                if delta.Magnitude > 50 then
                    hrp.CFrame = CFrame.new(lastPos)
                end
            end
            lastPos = hrp.Position
        end)
    end
    
    if getLoopWsState and getLoopWsState() then
        originalWalkSpeed = nil
        if loopWsConn then
            loopWsConn:Disconnect()
            loopWsConn = nil
        end
        loopWsConn = RunService.Heartbeat:Connect(function()
            local c = LocalPlayer.Character
            if not c then return end
            
            local hum = c:FindFirstChildOfClass("Humanoid")
            if hum then
                if originalWalkSpeed == nil then
                    originalWalkSpeed = hum.WalkSpeed
                end
                hum.WalkSpeed = targetWalkSpeed
            end
        end)
    end
    
    stopEmote()
end

LocalPlayer.CharacterAdded:Connect(OnCharacterAdded)
LocalPlayer.CharacterRemoving:Connect(function()
    stopEmote()
    for plr, _ in pairs(tracerState.players) do
        clearTracerForPlayer(plr)
    end
end)

if LocalPlayer.Character then
    OnCharacterAdded(LocalPlayer.Character)
end

print("‚úÖ Mod menu loaded successfully!")
